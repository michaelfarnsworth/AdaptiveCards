# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# [Template] Pack and optionally publish UPM packages.

parameters:
  projectRoot: $(Build.SourcesDirectory)/MixedRealityToolkit-Unity
  outputDirectory: $(Build.ArtifactStagingDirectory)/build/upm/output
  buildNumber: $(Build.BuildNumber)
  previewTag: $(MRTKReleaseTag)
  publishToArtifacts: true
  publishToFeed: false

steps:
- task: PowerShell@2
  displayName: 'Pack .NET UPM package'
  inputs:
    pwsh: true
    targetType: filePath
    filePath: ${{ parameters.projectRoot }}/scripts/upm/pack-upm.ps1
    arguments: >
      -ProjectRoot: ${{ parameters.projectRoot }}
      -OutputDirectory: ${{ parameters.outputDirectory }}
      -BuildNumber: ${{ parameters.buildNumber }}

- ${{ if eq(parameters.publishToArtifacts, true) }}:
  - task: PublishBuildArtifacts@1
    displayName: 'Publish UPM artifacts'
    inputs:
      pathToPublish: ${{ parameters.outputDirectory }}
      artifactName: "upm"

- ${{ if eq(parameters.publishToFeed, true) }}:
  - template: Tasks/publish-upm.yml
    parameters:
      packageDirectory: ${{ parameters.outputDirectory }}
      registryPath: $(UpmRegistry)
      authenticationEndpoint: $(ServiceConnectionName)